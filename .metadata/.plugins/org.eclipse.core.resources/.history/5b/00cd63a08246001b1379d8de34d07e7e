package protocol3.events;

import java.util.Random;
import java.util.UUID;

import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;

import net.md_5.bungee.api.chat.TextComponent;
import protocol3.backend.Config;
import protocol3.backend.PlayerMeta;
import protocol3.commands.Stealth;

// Chat Events
// protocol3. DO NOT REDISTRIBUTE!

public class Chat implements Listener
{

	private static Random random = new Random();
	@EventHandler
	public void onChat(AsyncPlayerChatEvent e)
	{

		// Let festive plugins override
		if (Bukkit.getServer().getPluginManager().getPlugin("Protocol3C") != null)
		{
			return;
		}

		// Cancel this event so we can override vanilla chat
		e.setCancelled(true);

		// Don't execute period if the player is muted
		if (PlayerMeta.isMuted(e.getPlayer()))
			return;

		// -- CREATE PROPERTIES --

		// Chat color to send the message with.
		String color;
		// The final edited message.
		String finalMessage = e.getMessage();
		// If we should send the final message.
		boolean doSend = true;
		// The username color.
		String usernameColor;
		// If the user is a bot.
		boolean isBot = e.getPlayer().getUniqueId().equals(UUID.fromString(Config.getValue("discord.uuid")));

		// -- SET CHAT COLORS -- //

		// Greentext
		if (e.getMessage().startsWith(">"))
		{
			color = "§a";
		}
		// Donator text
		else if (e.getMessage().startsWith("$") && PlayerMeta.isDonator(e.getPlayer()))
		{
			color = "§6";
		}
		// Normal text
		else
		{
			color = "§f";
		}

		/*
		 * // -- SET USERNAME COLOR -- // if (e.getPlayer().isOp() &&
		 * !Stealth.stealth.contains(e.getPlayer().getUniqueId())) { usernameColor =
		 * "§c"; } else if (PlayerMeta.isDonator(e.getPlayer())) { usernameColor = "§6";
		 * } else { usernameColor = "§f"; }
		 */

		int temp = random.nextInt(3) + 1;
		if (temp == 1)
		{
			usernameColor = "§4";
		} else if (temp == 2)
		{
			usernameColor = "§2";
		} else if (temp == 3)
		{
			usernameColor = "§f";
		} else
		{
			usernameColor = "§d";
		}

		// -- STRING MODIFICATION -- //

		// Remove section symbols
		finalMessage = finalMessage.replace('§', ' ');

		// -- CHECKS -- //

		if (isBlank(finalMessage))
			doSend = false;

		// -- SEND FINAL MESSAGE -- //

		if (doSend && !isBot && !Stealth.stealth.contains(e.getPlayer().getUniqueId()))
		{
			String username = e.getPlayer().getName();

			TextComponent finalCom = new TextComponent(
					"§f<" + usernameColor + username + "§f> " + color + finalMessage);

			Bukkit.getServer().spigot().broadcast(finalCom);
		}

		if (Stealth.stealth.contains(e.getPlayer().getUniqueId()))
		{
			String username = Stealth.fakeName.get(e.getPlayer().getUniqueId());

			TextComponent finalCom = new TextComponent(
					"§f<" + usernameColor + username + "§f> " + color + finalMessage);

			Bukkit.getServer().spigot().broadcast(finalCom);
		}

		// -- UNLESS BOT, THEN OVERRIDE ALL //
		if (isBot)
		{
			TextComponent finalCom = new TextComponent("§f<§9Bot§f> " + finalMessage);
			Bukkit.getServer().spigot().broadcast(finalCom);
		}
	}

	@EventHandler
	public boolean onCommand(PlayerCommandPreprocessEvent e)
	{
		if (e.getMessage().split(" ")[0].contains(":") && !e.getPlayer().isOp())
		{
			e.getPlayer().spigot().sendMessage(new TextComponent("§cUnknown command."));
			e.setCancelled(true);
			return true;
		}
		return true;
	}

	// String blank check since HeavyNode is on an older version of Java
	// that doesn't support this
	private boolean isBlank(String check)
	{
		// If string length is 0, it is empty
		boolean isEmpty = check.length() == 0;
		if (isEmpty)
			return true;

		// Return true if there is any character in the array
		char[] checkArray = new char[check.length()];
		for (int i = 0; i < check.length(); i++)
		{
			checkArray[i] = check.charAt(i);
		}

		// If it's a space, count it as an empty character
		for (char c : checkArray)
		{
			if (c == ' ')
				continue;
			else
				return false;
		}
		return true;
	}
}
